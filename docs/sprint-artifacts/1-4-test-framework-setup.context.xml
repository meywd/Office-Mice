<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.4</storyId>
    <title>Test Framework Setup</title>
    <status>drafted</status>
    <generatedAt>2025-11-17</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>/home/meywd/Office-Mice/docs/sprint-artifacts/1-4-test-framework-setup.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>automated testing infrastructure</iWant>
    <soThat>I can refactor confidently and catch regressions early</soThat>
    <tasks>1. Configure EditMode test assembly
2. Configure PlayMode test assembly
3. Create test data factory classes
4. Set up CI/CD pipeline with test automation
5. Create base test classes with common utilities
6. Implement sample tests for each interface
7. Configure coverage reporting</tasks>
  </story>

  <acceptanceCriteria>- Given codebase needs reliable testing
- When test framework is set up
- Then Unity Test Framework is integrated with separate EditMode and PlayMode assemblies
- And test data factories exist for reproducible test scenarios
- And mock implementations exist for all interface contracts
- And CI/CD pipeline configuration includes automated test execution</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/epics.md" title="Epic Breakdown" section="Epic 1: Foundation & Data Architecture" snippet="Epic 1 delivers foundational value with stories covering core data models, configuration systems, interface contracts, testing infrastructure, and performance benchmarking. Story 1.4 specifically focuses on automated testing infrastructure setup." />
      <doc path="docs/ARCHITECTURE.md" title="System Architecture" section="Testing Architecture" snippet="Test structure with Assets/Tests/EditMode/ and Assets/Tests/PlayMode/ assemblies. Test data factory pattern with MapGenerationTestDataFactory for reproducible scenarios. 90%+ code coverage requirement with comprehensive validation." />
      <doc path="docs/ARCHITECTURE.md" title="System Architecture" section="Performance Architecture" snippet="Object pooling system with generic ObjectPool&lt;T&gt; class and specialized pools. Coroutine-based generation with frame-time budgeting maintains 16.67ms per frame performance. Performance monitoring with ProductionMonitor class." />
      <doc path="docs/ARCHITECTURE.md" title="System Architecture" section="CI/CD Pipeline" snippet="GitHub Actions workflow with Unity Test Runner integration. Automated testing, WebGL builds, and Cloudflare deployment. Performance benchmarking validation in CI/CD pipeline." />
      <doc path="docs/sprint-artifacts/1-3-interface-contracts.context.xml" title="Interface Contracts Context" section="Interfaces" snippet="Core interfaces include IMapGenerator, IRoomGenerator, ICorridorGenerator, IContentPopulator with mock implementations already created. Supporting interfaces include IPathfinder, ITileRenderer, IAssetLoader." />
    </docs>
    <code>
      <code path="Assets/Scripts/MapGeneration/Interfaces/IMapGenerator.cs" kind="interface" symbol="IMapGenerator" lines="1-20" reason="Main generation pipeline interface requiring async test support" />
      <code path="Assets/Scripts/MapGeneration/Interfaces/IRoomGenerator.cs" kind="interface" symbol="IRoomGenerator" lines="1-15" reason="Room generation interface needing deterministic test scenarios" />
      <code path="Assets/Scripts/MapGeneration/Interfaces/ICorridorGenerator.cs" kind="interface" symbol="ICorridorGenerator" lines="1-15" reason="Corridor generation interface requiring connectivity validation tests" />
      <code path="Assets/Scripts/MapGeneration/Interfaces/IContentPopulator.cs" kind="interface" symbol="IContentPopulator" lines="1-20" reason="Content population interface needing asset loading test support" />
      <code path="Assets/Scripts/MapGeneration/Interfaces/IPathfinder.cs" kind="interface" symbol="IPathfinder" lines="1-15" reason="Pathfinding interface requiring obstacle map test scenarios" />
      <code path="Assets/Scripts/MapGeneration/Interfaces/ITileRenderer.cs" kind="interface" symbol="ITileRenderer" lines="1-15" reason="Tile rendering interface needing Unity Tilemap test integration" />
      <code path="Assets/Scripts/MapGeneration/Interfaces/IAssetLoader.cs" kind="interface" symbol="IAssetLoader" lines="1-20" reason="Asset loading interface requiring caching and preload test scenarios" />
      <code path="Assets/Tests/EditMode/MapGeneration/Mocks/MockMapGenerator.cs" kind="mock" symbol="MockMapGenerator" lines="1-50" reason="Existing mock implementation for IMapGenerator testing" />
      <code path="Assets/Tests/EditMode/MapGeneration/Mocks/MockRoomGenerator.cs" kind="mock" symbol="MockRoomGenerator" lines="1-40" reason="Existing mock implementation for IRoomGenerator testing" />
      <code path="Assets/Tests/EditMode/MapGeneration/Mocks/MockCorridorGenerator.cs" kind="mock" symbol="MockCorridorGenerator" lines="1-40" reason="Existing mock implementation for ICorridorGenerator testing" />
      <code path="Assets/Tests/EditMode/MapGeneration/Mocks/MockContentPopulator.cs" kind="mock" symbol="MockContentPopulator" lines="1-40" reason="Existing mock implementation for IContentPopulator testing" />
      <code path="Assets/Tests/EditMode/MapGeneration/Mocks/MockPathfinder.cs" kind="mock" symbol="MockPathfinder" lines="1-30" reason="Existing mock implementation for IPathfinder testing" />
      <code path="Assets/Tests/EditMode/MapGeneration/Mocks/MockTileRenderer.cs" kind="mock" symbol="MockTileRenderer" lines="1-30" reason="Existing mock implementation for ITileRenderer testing" />
      <code path="Assets/Tests/EditMode/MapGeneration/Mocks/MockAssetLoader.cs" kind="mock" symbol="MockAssetLoader" lines="1-40" reason="Existing mock implementation for IAssetLoader testing" />
      <code path="Assets/Tests/EditMode/MapGeneration/Data/MapDataTests.cs" kind="test" symbol="MapDataTests" lines="1-100" reason="Existing test patterns showing data model validation approaches" />
      <code path="Assets/Tests/EditMode/MapGeneration/Interfaces/IMapGeneratorTests.cs" kind="test" symbol="IMapGeneratorTests" lines="1-80" reason="Existing interface test patterns requiring assembly setup" />
      <code path="Assets/Scripts/MapGeneration/Data/MapData.cs" kind="data-model" symbol="MapData" lines="1-100" reason="Core data structure needing comprehensive test coverage" />
      <code path="Assets/Scripts/MapGeneration/Validation/ValidationResult.cs" kind="utility" symbol="ValidationResult" lines="1-50" reason="Validation system used across all tests for error reporting" />
    </code>
    <dependencies>
      <unity>
        <package name="com.unity.test-framework" version="1.4.5" usage="Unity Test Framework for EditMode and PlayMode testing" />
        <package name="com.unity.2d.tilemap" version="1.0.0" usage="Tilemap rendering system for visual output testing" />
        <package name="com.h8man.2d.navmeshplus" version="master" usage="2D NavMesh generation for AI navigation testing" />
        <package name="com.unity.ai.navigation" version="2.0.9" usage="Navigation system integration testing" />
        <package name="com.unity.2d.tilemap.extras" version="package" usage="Additional tilemap utilities for testing" />
      </unity>
      <frameworks>
        <framework name="NUnit" version="3.x" usage="Unit testing framework integrated with Unity Test Framework" />
        <framework name="Unity Test Framework" version="1.4.5" usage="Unity-specific testing utilities and runtime testing" />
        <framework name="Unity Performance Testing" version="available" usage="Performance benchmarking and regression testing" />
        <framework name="Unity Code Coverage" version="available" usage="90%+ code coverage reporting and validation" />
      </frameworks>
      <testing-tools>
        <tool name="Unity Test Runner" usage="Integrated test execution in Unity Editor and CI/CD" />
        <tool name="GitHub Actions" usage="CI/CD pipeline for automated test execution" />
        <tool name="Unity Cloud Build" usage="Optional cloud testing and build validation" />
        <tool name="Coverage.py" usage="Code coverage analysis and reporting" />
      </testing-tools>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="unity-version" description="Unity 6000.2.12f1 (Unity 6.0 LTS) - Test Framework must be compatible with Unity 6" />
    <constraint type="test-assemblies" description="Separate EditMode and PlayMode test assemblies with proper dependencies and references" />
    <constraint type="code-coverage" description="90%+ code coverage requirement across all map generation components" />
    <constraint type="ci-cd-integration" description="Tests must run in GitHub Actions workflow with Unity Test Runner integration" />
    <constraint type="mock-implementations" description="All interface contracts must have comprehensive mock implementations for isolated testing" />
    <constraint type="test-data-factories" description="Test data factories must create reproducible scenarios with deterministic seed-based generation" />
    <constraint type="performance-testing" description="Performance tests must validate frame-time budgeting and object pooling effectiveness" />
    <constraint type="async-testing" description="Async operations must be testable with proper coroutine handling and frame-time validation" />
    <constraint type="unity-integration" description="Tests must integrate with Unity Tilemap, NavMeshPlus, and serialization systems" />
    <constraint type="editor-vs-runtime" description="EditMode tests for unit testing, PlayMode tests for integration and end-to-end scenarios" />
  </constraints>
  <interfaces>
    <interface name="IMapGenerator" kind="generation-pipeline" signature="IEnumerator&lt;MapData&gt; GenerateMapAsync(MapGenerationSettings settings, int seed = 0)" path="Assets/Scripts/MapGeneration/Interfaces/IMapGenerator.cs" description="Main generation pipeline abstraction requiring async test support and frame-time budgeting validation" />
    <interface name="IRoomGenerator" kind="room-creation" signature="List&lt;RoomData&gt; GenerateRooms(MapGenerationSettings settings)" path="Assets/Scripts/MapGeneration/Interfaces/IRoomGenerator.cs" description="Room creation abstraction using BSP algorithm requiring deterministic test scenarios" />
    <interface name="ICorridorGenerator" kind="pathfinding" signature="List&lt;CorridorData&gt; ConnectRooms(List&lt;RoomData&gt; rooms, MapGenerationSettings settings)" path="Assets/Scripts/MapGeneration/Interfaces/ICorridorGenerator.cs" description="Corridor generation using A* pathfinding requiring connectivity validation tests" />
    <interface name="IContentPopulator" kind="content-population" signature="void PopulateContent(MapData map, BiomeConfiguration biome)" path="Assets/Scripts/MapGeneration/Interfaces/IContentPopulator.cs" description="Furniture, spawn points, and resource placement requiring asset loading test support" />
    <interface name="IPathfinder" kind="pathfinding" signature="List&lt;Vector2Int&gt; FindPath(Vector2Int start, Vector2Int end, bool[,] obstacles)" path="Assets/Scripts/MapGeneration/Interfaces/IPathfinder.cs" description="A* pathfinding abstraction requiring obstacle map test scenarios and performance validation" />
    <interface name="ITileRenderer" kind="rendering" signature="void RenderMap(MapData map, Tilemap[] tilemaps)" path="Assets/Scripts/MapGeneration/Interfaces/ITileRenderer.cs" description="Unity Tilemap rendering abstraction requiring Unity integration testing" />
    <interface name="IAssetLoader" kind="asset-management" signature="TileBase LoadTile(string tileName)" path="Assets/Scripts/MapGeneration/Interfaces/IAssetLoader.cs" description="Asset loading and caching abstraction requiring preload and cache test scenarios" />
  </interfaces>
  <tests>
    <standards>Unity Test Framework with NUnit 3.x integration. EditMode tests for unit testing interfaces, data models, and mock implementations. PlayMode tests for integration testing with Unity systems. Test data factories using MapGenerationTestDataFactory pattern for reproducible scenarios. Comprehensive validation using ValidationResult system. 90%+ code coverage requirement with Unity Code Coverage package. Performance testing using Unity Performance Testing API. Async testing with proper coroutine handling and frame-time budgeting validation.</standards>
    <locations>Assets/Tests/EditMode/MapGeneration.EditMode.Tests.asmdef for unit tests. Assets/Tests/PlayMode/MapGeneration.PlayMode.Tests.asmdef for integration tests. Assets/Tests/EditMode/MapGeneration/Factories/ for test data factories. Assets/Tests/EditMode/MapGeneration/Base/ for base test classes and utilities. Assets/Tests/EditMode/MapGeneration/Performance/ for performance benchmarking tests. GitHub Actions workflow .github/workflows/test.yml for CI/CD test execution.</locations>
    <ideas>
      <test idea="Unity Test Framework assembly configuration with proper references" acceptance-criteria="AC1" />
      <test idea="Test data factory for MapGenerationSettings with reproducible seeds" acceptance-criteria="AC2" />
      <test idea="Mock implementations validate all interface contracts" acceptance-criteria="AC3" />
      <test idea="CI/CD pipeline executes all tests and generates coverage reports" acceptance-criteria="AC4" />
      <test idea="EditMode assembly tests all interfaces and data models in isolation" acceptance-criteria="AC1" />
      <test idea="PlayMode assembly tests integration with Unity Tilemap and NavMesh" acceptance-criteria="AC1" />
      <test idea="Base test classes provide common utilities for setup/teardown" acceptance-criteria="AC2" />
      <test idea="Sample tests demonstrate proper testing patterns for each interface" acceptance-criteria="AC3" />
      <test idea="Coverage reporting validates 90%+ coverage across all components" acceptance-criteria="AC4" />
      <test idea="Performance tests validate frame-time budgeting and object pooling" acceptance-criteria="AC4" />
      <test idea="Async operation testing with proper coroutine handling" acceptance-criteria="AC1" />
      <test idea="Deterministic test scenarios with seed-based reproducibility" acceptance-criteria="AC2" />
    </ideas>
  </tests>
</story-context>